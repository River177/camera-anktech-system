# 复眼型阵列监控摄像机 Web 控制系统

## 📹 系统简介

基于 **AnkTech SDK** 开发的复眼型阵列监控摄像机 Web 控制系统。

### 硬件配置
- **设备类型**：复眼型阵列监控摄像机
- **镜头数量**：52 个
  - 🔵 **4 个主镜头**：用于全景拼接
  - 🔵 **48 个分镜头**：独立视频流

### 输出画面
- **全景画面**：4 个主镜头拼接，32:9 超宽比例
- **分镜头画面**：48 个独立 16:9 视频流

---

## 🖥️ 服务器配置

**服务器地址**：`10.10.18.242`

| 服务 | 端口 | 账号 | 密码 | 用途 |
|------|------|------|------|------|
| **中心服务** | 8899/WS:7777 | aqcenter55 | 123 | SDK登录、设备管理 |
| **流媒体服务** | 8866/WS:7788 | akmts55 | 123 | 视频流传输 |
| **拼接服务** | 8081 | akss55 | 123 | 全景拼接 |
| **录像服务** | 8081 | akrs55 | 123 | 录像存储 |

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pnpm install
```

### 2. 启动开发服务器

```bash
pnpm dev
```

### 3. 打开浏览器

```
http://localhost:3000
```

### 4. 自动登录

系统会自动：
- ✅ 登录中心服务（aqcenter55）
- ✅ 建立 WebSocket 连接
- ✅ 获取设备列表
- ✅ 显示全景和分镜头

---

## 🎬 播放组件使用

### AnkTechPlayer 组件位置

**文件**：`src/components/monitoring/AnkTechPlayer.tsx`

### 播放全景画面（4 主镜头拼接）

```tsx
import { AnkTechPlayer } from '@/components/monitoring/AnkTechPlayer';

<AnkTechPlayer
  mediaId={99999}              // 全景视频 ID（从拼接列表获取）
  mts="10.10.18.242:7788"      // 流媒体服务地址
  StitchID="akss55"            // 拼接服务 ID
  StitchIndex={0}              // 拼接索引
  CamID="compound_eye_camera"  // 摄像机 ID
/>
```

### 播放分镜头

```tsx
<AnkTechPlayer
  mediaId={10001}              // 分镜头视频 ID（从通道列表获取）
  mts="10.10.18.242:7788"      // 流媒体服务地址
  CamID="camera_01"            // 摄像机 ID
  ChnID="camera_01_0"          // 通道 ID
/>
```

---

## 📊 数据获取流程

### 自动获取流程

```
1. 登录成功
   ↓
2. WebSocket 连接 (ws://10.10.18.242:7777)
   ↓
3. 收到 CMD: 900001 (连接成功)
   ↓
4. 自动发送请求：
   - getDeviceList() → CMD: 30006
   - getChannelList() → CMD: 30007 ← 48个分镜头
   - getStitchList() → CMD: 30013 ← 全景拼接
   ↓
5. 收到数据，存储在 React 状态中
   - cameras: 摄像头列表
   - channels: 通道列表（48个分镜头）
   - stitches: 拼接列表（全景）
   - treeData: 树形结构（用于UI显示）
   ↓
6. 界面显示设备列表
   ↓
7. 自动或手动播放视频
```

### 播放全景所需数据

**来源**：CMD: 30013（拼接列表）

```javascript
// 从消息中提取
const stitch = StitchServerArr[0];
const stitcher = stitch.StitcherArr[0];

// 播放参数
const panoramaParams = {
  mediaId: stitcher.ChnArr[0].VideoID,       // 视频 ID
  mts: `${stitcher.MtsIP}:${stitcher.MtsWsPort}`,  // "10.10.18.242:7788"
  StitchID: stitch.StitchID,                 // "akss55"
  StitchIndex: stitcher.Index,               // 0
  CamID: stitcher.CamID,                     // 摄像机 ID
};
```

### 播放分镜头所需数据

**来源**：CMD: 30007（通道列表）

```javascript
// 从消息中提取
const channel = ChannelArray[x];

// 播放参数
const channelParams = {
  mediaId: channel.MainVideoID,              // 主流视频 ID
  mts: `${channel.MtsIP}:${channel.MtsWsPort}`,  // "10.10.18.242:7788"
  CamID: channel.CamID,                      // 摄像机 ID
  ChnID: channel.ChnID,                      // 通道 ID
};
```

---

## 🎨 界面布局

```
┌────────────────────────────────────────────────────────┐
│  复眼型阵列监控摄像机系统              [登出]          │
├────────────┬───────────────────────────────────────────┤
│            │  【全景画面 - 32:9】      [全景截图]      │
│  设备列表   │  ┌─────────────────────────────────────┐  │
│            │  │                                     │  │
│ 📷 全景拼接│  │  4个主镜头拼接的超宽全景画面         │  │
│  └ 全景通道│  │                                     │  │
│            │  └─────────────────────────────────────┘  │
│ 📷 摄像头1 │                                           │
│  └ 通道1   │  【分镜头画面 - 16:9】      [截图]        │
│            │  ┌────────────────────┐                   │
│ 📷 摄像头2 │  │                    │                   │
│  └ 通道2   │  │   主视频窗口       │                   │
│            │  │                    │                   │
│ ... (52个) │  └────────────────────┘                   │
│            │  ┌────┐ ┌────┐ ┌────┐ ┌────┐            │
│            │  │ 1  │ │ 2  │ │ 3  │ │ 4  │ 子视频     │
│            │  └────┘ └────┘ └────┘ └────┘            │
└────────────┴───────────────────────────────────────────┘
```

---

## 🔧 核心技术

### 前端技术栈
- **框架**：React 18 + TypeScript
- **UI 库**：Tailwind CSS + shadcn/ui
- **构建工具**：Vite
- **视频播放**：AnkTech SDK

### 后端服务
- **中心服务**：设备管理、WebSocket 消息
- **流媒体服务**：视频流传输
- **拼接服务**：4 主镜头拼接
- **录像服务**：录像存储和回放

---

## 📁 项目结构

```
camera-anktech-system/
├── src/
│   ├── assets/anktech/          # AnkTech SDK
│   │   ├── AnkTechSDK.esm.js    # SDK 主文件
│   │   └── types/               # TypeScript 类型定义
│   │
│   ├── components/
│   │   ├── monitoring/
│   │   │   └── AnkTechPlayer.tsx  # 🎬 视频播放组件
│   │   └── ui/                  # UI 组件库
│   │
│   ├── hooks/
│   │   └── useAnkTech.ts        # 🪝 SDK React Hook
│   │
│   ├── services/
│   │   └── AnkTechService.ts    # 🔧 SDK 服务封装
│   │
│   ├── pages/
│   │   ├── MonitoringPage.tsx   # 📺 监控主页
│   │   └── DiagnosticPage.tsx   # 🔍 诊断页面
│   │
│   └── types/
│       └── anktech.ts           # 类型定义
│
├── 系统配置文档.md               # 📖 服务器配置说明
├── 完整使用指南.md               # 📖 使用指南
└── 快速配置参考.md               # 📖 快速参考
```

---

## 🎯 主要功能

### ✅ 已实现

- ✅ **自动登录**：使用 aqcenter55 账号自动登录
- ✅ **WebSocket 连接**：自动建立和维护连接
- ✅ **设备列表**：自动获取并显示 52 个摄像头
- ✅ **全景播放**：支持 32:9 全景画面
- ✅ **分镜头播放**：支持 48 个分镜头播放
- ✅ **多窗口播放**：1 个主视频 + 4 个子视频
- ✅ **截图功能**：支持视频截图
- ✅ **录像功能**：支持开始/停止录像
- ✅ **状态监控**：实时显示设备在线/离线状态
- ✅ **PTZ 控制**：支持球机云台控制
- ✅ **ROI 框选**：支持视频区域框选

---

## 🔐 安全配置

### 开发环境（当前）
- HTTP 连接
- 简单密码
- 无加密传输

### 生产环境（建议）
- [ ] 配置 HTTPS/WSS
- [ ] 使用强密码
- [ ] 配置 JWT Token
- [ ] 配置 Nginx 反向代理
- [ ] 限制访问 IP

---

## 🐛 故障排查

### 问题 1: 拼接列表为空

**症状**：显示"等待全景拼接服务..."

**检查**：
1. 拼接服务（akss55）是否启动？
2. 4 个主镜头是否在线？
3. 端口 7777 和 7788 是否开放？

### 问题 2: 分镜头列表为空

**症状**：左侧没有显示摄像头

**检查**：
1. 中心服务是否返回设备数据？
2. 查看控制台日志
3. 执行 `__debugTreeData` 查看数据

### 问题 3: 视频黑屏

**症状**：视频区域是黑色

**检查**：
1. 流媒体服务（akmts55）是否运行？
2. 端口 7788 是否可访问？
3. Network → WS 中是否有视频流连接？

---

## 📚 文档索引

| 文档 | 内容 |
|------|------|
| `系统配置文档.md` | 服务器配置、端口说明、服务账号 |
| `完整使用指南.md` | 使用步骤、代码示例、数据结构 |
| `快速配置参考.md` | 快速参考卡片、关键配置 |
| `WebSocket连接说明.md` | WebSocket 连接原理 |
| `故障排查.md` | 常见问题解决方案 |

---

## 🎉 开始使用

```bash
# 1. 启动服务器
pnpm dev

# 2. 打开浏览器
http://localhost:3000

# 3. 查看控制台（F12）
检查登录和设备数据

# 4. 享受 52 目摄像头系统！
```

---

**技术支持**：查看项目文档或联系开发团队


