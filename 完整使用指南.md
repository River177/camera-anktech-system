# 复眼型阵列监控摄像机 - 完整使用指南

## 🎥 系统概述

### 硬件配置
- **设备类型**：复眼型阵列监控摄像机
- **镜头总数**：52 个
  - **主镜头**：4 个（用于全景拼接）
  - **分镜头**：48 个（独立视频流）

### 输出画面
- **全景画面**：4 个主镜头拼接成 32:9 超宽全景
- **分镜头画面**：48 个独立 16:9 视频流

---

## ✅ 已配置完成

### 1. 登录配置

**文件**：`src/pages/MonitoringPage.tsx`

```typescript
const LOGIN_CONFIG = {
  server: '10.10.18.242',  // 服务器地址
  wsPort: 7777,            // 中心服务 WebSocket 端口
  userId: 'aqcenter55',    // 中心服务账号 ✅
  password: '123',         // 中心服务密码 ✅
  debug: true,
};
```

### 2. Vite 代理配置

**文件**：`vite.config.ts`

```typescript
proxy: {
  '/aqueti-api': {
    target: 'http://10.10.18.242:8081',  // HTTP API 统一认证接口
    changeOrigin: true,
  }
}
```

### 3. 播放组件

**文件**：`src/components/monitoring/AnkTechPlayer.tsx`

已经封装好，自动处理视频流播放。

---

## 🚀 使用步骤

### 步骤 1: 启动开发服务器

```bash
cd camera-anktech-system
pnpm dev
```

服务器会运行在：`http://localhost:3000`

---

### 步骤 2: 打开浏览器

访问：`http://localhost:3000`

---

### 步骤 3: 自动登录流程

页面会自动执行以下流程：

```
1. 自动登录中心服务
   账号：aqcenter55
   密码：123
   ↓
2. 建立 WebSocket 连接
   ws://10.10.18.242:7777
   ↓
3. 接收连接成功消息
   CMD: 900001
   ↓
4. 自动获取设备信息
   - getDeviceList() → CMD: 30006
   - getChannelList() → CMD: 30007
   - getStitchList() → CMD: 30013
   ↓
5. 显示设备列表
   ├── 全景拼接服务（4个主镜头）
   └── 52 个摄像头（48个分镜头）
```

---

### 步骤 4: 查看全景画面

#### 方式 A: 自动播放（如果已配置）

系统会自动检测拼接服务并播放全景画面（32:9）

#### 方式 B: 手动点击

1. 点击左侧**"全景拼接服务"**
2. 选择**"全景通道"**
3. 全景画面开始播放

---

### 步骤 5: 播放分镜头

1. 在左侧设备列表中选择任意摄像头
2. 点击该摄像头下的通道
3. 视频会在右侧播放

---

## 📊 预期的数据结构

### CMD: 30013 - 拼接列表（全景）

```json
{
  "CMD": 30013,
  "StitchServerArr": [
    {
      "StitchID": "akss55",
      "StitchName": "4主镜头全景拼接",
      "Status": 1,
      "StitcherArr": [
        {
          "Index": 0,
          "StitcherName": "全景通道",
          "CamID": "compound_eye_camera",
          "MtsIP": "10.10.18.242",
          "MtsWsPort": 7788,
          "MtsID": "akmts55",
          "ChnArr": [
            {
              "ChnID": 0,
              "VideoID": 99999  // 全景视频 ID
            }
          ]
        }
      ]
    }
  ]
}
```

### CMD: 30007 - 通道列表（48个分镜头）

```json
{
  "CMD": 30007,
  "ChannelArray": [
    {
      "CamID": "camera_01",
      "ChnID": "camera_01_0",
      "ChnName": "分镜头1",
      "Status": 1,
      "MtsIP": "10.10.18.242",
      "MtsWsPort": 7788,
      "MainVideoID": 10001,
      "SubVideoID": 10002
    },
    {
      "CamID": "camera_02",
      "ChnID": "camera_02_0",
      "ChnName": "分镜头2",
      "Status": 1,
      "MtsIP": "10.10.18.242",
      "MtsWsPort": 7788,
      "MainVideoID": 10003,
      "SubVideoID": 10004
    }
    // ... 48 个分镜头通道
  ]
}
```

---

## 🎬 播放全景画面所需信息

### 从 CMD: 30013 中提取：

```javascript
const stitch = StitchServerArr[0];
const stitcher = stitch.StitcherArr[0];

// 播放全景需要的参数：
{
  mediaId: stitcher.ChnArr[0].VideoID,       // 视频 ID
  mts: `${stitcher.MtsIP}:${stitcher.MtsWsPort}`,  // "10.10.18.242:7788"
  StitchID: stitch.StitchID,                 // 拼接服务 ID
  StitchIndex: stitcher.Index,               // 拼接索引（通常是 0）
  CamID: stitcher.CamID,                     // 摄像机 ID
}
```

### 使用 AnkTechPlayer 播放：

```tsx
<AnkTechPlayer
  mediaId={stitcher.ChnArr[0].VideoID}
  mts="10.10.18.242:7788"
  StitchID={stitch.StitchID}
  StitchIndex={0}
  CamID={stitcher.CamID}
/>
```

---

## 🎯 播放 48 个分镜头所需信息

### 从 CMD: 30007 中提取：

```javascript
// 对于每个通道
const channel = ChannelArray[x];

// 播放分镜头需要的参数：
{
  mediaId: channel.MainVideoID,              // 主流视频 ID（或 SubVideoID 用子流）
  mts: `${channel.MtsIP}:${channel.MtsWsPort}`,  // "10.10.18.242:7788"
  CamID: channel.CamID,                      // 摄像机 ID
  ChnID: channel.ChnID,                      // 通道 ID
}
```

### 使用 AnkTechPlayer 播放：

```tsx
<AnkTechPlayer
  mediaId={channel.MainVideoID}
  mts="10.10.18.242:7788"
  CamID={channel.CamID}
  ChnID={channel.ChnID}
/>
```

---

## 💻 完整代码示例

### 示例 1: 全景 + 4 个分镜头（推荐布局）

```tsx
import { useAnkTech } from '@/hooks/useAnkTech';
import { AnkTechPlayer } from '@/components/monitoring/AnkTechPlayer';

export default function PanoramaWithSubCameras() {
  const { isLoggedIn, stitches, treeData } = useAnkTech({
    server: '10.10.18.242',
    wsPort: 7777,
    userId: 'aqcenter55',
    password: '123',
    debug: true,
  });
  
  // 获取全景拼接
  const panorama = stitches?.[0]?.StitcherArr?.[0];
  
  // 获取前 4 个分镜头
  const subChannels = treeData
    .flatMap(node => node.channels || [])
    .filter(ch => ch.status === 1 && ch.mediaId && ch.type === 'channel')
    .slice(0, 4);
  
  return (
    <div className="h-screen bg-black p-4 flex flex-col gap-4">
      {/* 全景画面 - 32:9 */}
      <div className="flex-1">
        <h2 className="text-white mb-2">全景画面（4主镜头拼接）</h2>
        {panorama && panorama.ChnArr[0]?.VideoID ? (
          <div style={{ aspectRatio: '32 / 9', height: '100%' }}>
            <AnkTechPlayer
              mediaId={panorama.ChnArr[0].VideoID}
              mts={`${panorama.MtsIP}:${panorama.MtsWsPort}`}
              StitchID={stitches[0].StitchID}
              StitchIndex={panorama.Index}
              CamID={panorama.CamID}
            />
          </div>
        ) : (
          <div className="text-white">等待全景拼接服务...</div>
        )}
      </div>
      
      {/* 分镜头画面 - 4 个 */}
      <div className="h-64">
        <h2 className="text-white mb-2">分镜头（48个中的4个）</h2>
        <div className="grid grid-cols-4 gap-2 h-full">
          {subChannels.map((channel) => (
            <div key={channel.id}>
              <AnkTechPlayer
                mediaId={channel.mediaId}
                mts={channel.mts}
                CamID={channel.CamID}
                ChnID={channel.ChnID}
              />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
```

---

### 示例 2: 显示所有 48 个分镜头（分页）

```tsx
import { useState } from 'react';
import { useAnkTech } from '@/hooks/useAnkTech';
import { AnkTechPlayer } from '@/components/monitoring/AnkTechPlayer';
import { Button } from '@/components/ui/button';

export default function All48SubCameras() {
  const { treeData } = useAnkTech({
    server: '10.10.18.242',
    wsPort: 7777,
    userId: 'aqcenter55',
    password: '123',
  });
  
  const [page, setPage] = useState(0);
  const pageSize = 12; // 每页 12 个（3x4 网格）
  
  // 获取所有分镜头通道
  const allChannels = treeData
    .flatMap(node => node.channels || [])
    .filter(ch => ch.status === 1 && ch.mediaId && ch.type === 'channel');
  
  const totalPages = Math.ceil(allChannels.length / pageSize);
  const currentChannels = allChannels.slice(page * pageSize, (page + 1) * pageSize);
  
  return (
    <div className="min-h-screen bg-black p-4">
      <div className="flex justify-between mb-4">
        <h1 className="text-white text-2xl">
          48 个分镜头 - 第 {page + 1}/{totalPages} 页
        </h1>
        <div className="flex gap-2">
          <Button onClick={() => setPage(p => Math.max(0, p - 1))} disabled={page === 0}>
            上一页
          </Button>
          <Button onClick={() => setPage(p => Math.min(totalPages - 1, p + 1))} disabled={page >= totalPages - 1}>
            下一页
          </Button>
        </div>
      </div>
      
      {/* 3x4 网格 = 12 个分镜头 */}
      <div className="grid grid-cols-4 gap-4">
        {currentChannels.map((channel) => (
          <div key={channel.id}>
            <div className="text-white text-sm mb-1">{channel.name}</div>
            <div className="aspect-video">
              <AnkTechPlayer
                mediaId={channel.mediaId}
                mts={channel.mts}
                CamID={channel.CamID}
                ChnID={channel.ChnID}
              />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## 📊 系统工作流程

### 完整流程图

```
1. 用户打开浏览器
   http://localhost:3000
   ↓
2. 自动登录中心服务
   - 账号：aqcenter55
   - 密码：123
   - API: http://10.10.18.242:8081/aqueti-api/login
   ↓
3. 建立 WebSocket 连接
   - ws://10.10.18.242:7777 (中心服务)
   ↓
4. WebSocket 认证成功
   收到 CMD: 900001
   ↓
5. 自动获取设备信息
   - getDeviceList() → CMD: 30006 (摄像机列表)
   - getChannelList() → CMD: 30007 (48个分镜头通道)
   - getStitchList() → CMD: 30013 (全景拼接服务)
   ↓
6. 构建设备树 (treeData)
   - 摄像头节点
   - 通道节点
   - 拼接节点
   ↓
7. 渲染界面
   - 左侧：设备列表
   - 右上：全景画面（32:9）← 自动播放
   - 右下：分镜头画面（16:9）← 点击播放
   ↓
8. 播放视频流
   每个视频建立独立的 WebSocket 连接
   ws://10.10.18.242:7788
   ↓
9. ✅ 视频实时播放！
```

---

## 🔌 网络连接说明

### 两个 WebSocket 连接

#### 1. 控制 WebSocket（中心服务）
- **地址**：`ws://10.10.18.242:7777`
- **用途**：消息控制、设备管理
- **数量**：1 个（全局唯一）

#### 2. 视频流 WebSocket（流媒体服务）
- **地址**：`ws://10.10.18.242:7788`
- **用途**：视频数据传输
- **数量**：N 个（每个视频一个）

### 连接示意图

```
浏览器
  │
  ├─ HTTP API
  │  └─> http://10.10.18.242:8081/aqueti-api/*
  │
  ├─ 控制 WebSocket (1个)
  │  └─> ws://10.10.18.242:7777
  │
  └─ 视频流 WebSocket (N个)
     ├─> ws://10.10.18.242:7788 (全景视频)
     ├─> ws://10.10.18.242:7788 (分镜头1)
     ├─> ws://10.10.18.242:7788 (分镜头2)
     └─> ws://10.10.18.242:7788 (分镜头3)
     ...
```

---

## 🎬 AnkTechPlayer 组件使用

### 位置
`src/components/monitoring/AnkTechPlayer.tsx`

### Props 参数

```typescript
interface AnkTechPlayerProps {
  // 必需参数
  mediaId: number;        // ✅ 视频 ID
  mts: string;            // ✅ 媒体流地址 "IP:PORT"
  
  // 全景拼接参数（播放全景时需要）
  StitchID?: string;      // 拼接服务 ID
  StitchIndex?: number;   // 拼接索引
  StitchChnID?: string;   // 拼接通道 ID
  
  // 摄像头参数（播放分镜头时需要）
  CamID?: string;         // 摄像机 ID
  ChnID?: string;         // 通道 ID
  
  // 可选参数
  autoPlay?: boolean;     // 自动播放（默认 true）
  className?: string;     // CSS 类名
  onError?: (error: string) => void;  // 错误回调
}
```

### 使用示例

#### 播放全景（4 个主镜头拼接）

```tsx
<AnkTechPlayer
  mediaId={99999}              // 全景视频 ID
  mts="10.10.18.242:7788"      // 流媒体服务地址
  StitchID="akss55"            // 拼接服务 ID
  StitchIndex={0}              // 拼接索引
  CamID="compound_eye_camera"  // 摄像机 ID
/>
```

#### 播放分镜头

```tsx
<AnkTechPlayer
  mediaId={10001}              // 分镜头视频 ID
  mts="10.10.18.242:7788"      // 流媒体服务地址
  CamID="camera_01"            // 摄像机 ID
  ChnID="camera_01_0"          // 通道 ID
/>
```

---

## 🐛 调试步骤

### 1. 检查控制台日志

打开浏览器（F12），应该看到：

```javascript
✅ 正常流程：

[AnkTech] SDK版本: 2.2.952d4fb
[useAnkTech] 🚀 开始登录流程...
[useAnkTech] 登录配置: {
  server: "10.10.18.242",
  wsPort: 7777,
  userId: "aqcenter55"
}
[AnkTech] ✅ 登录成功
this.options.messageWs.url -> ws://10.10.18.242:7777
message ws onopen, readyState -> 1

[AnkTech] 📨 收到消息 CMD: 900001
[useAnkTech] ✅ WebSocket 已连接!
[useAnkTech] → 已发送获取设备列表请求 (CMD: 30006)
[useAnkTech] → 已发送获取通道列表请求 (CMD: 30007)
[useAnkTech] → 已发送获取拼接列表请求 (CMD: 30013)

[AnkTech] 📨 收到消息 CMD: 30006
[useAnkTech] 📷 收到设备列表: X 个设备

[AnkTech] 📨 收到消息 CMD: 30007
[useAnkTech] 📡 收到通道列表: 48 个通道  ← 应该是 48

[AnkTech] 📨 收到消息 CMD: 30013
[useAnkTech] 🔗 收到拼接列表: 1 个拼接服务  ← 应该有 1 个
```

---

### 2. 检查 Network 标签

**Network → WS** 应该看到：

```
✅ ws://10.10.18.242:7777  (101 Switching Protocols)
   - Messages: 看到 CMD: 900001, 30006, 30007, 30013

✅ ws://10.10.18.242:7788  (101 Switching Protocols) 
   - 全景视频流连接

✅ ws://10.10.18.242:7788  (101 Switching Protocols)
   - 分镜头视频流连接
   ... (如果打开了多个)
```

---

### 3. 检查设备数据

在控制台执行：

```javascript
// 查看所有设备
__debugTreeData

// 查看拼接服务
__debugTreeData.filter(d => d.type === 'stitch')

// 应该看到：
[
  {
    id: "akss55",
    name: "全景拼接服务",
    type: "stitch",
    status: 1,  // 在线
    channels: [
      {
        id: "akss55_0",
        name: "全景通道",
        type: "stitcher",
        mediaId: 99999,  // 有视频 ID
        StitchID: "akss55",
        StitchIndex: 0,
        ...
      }
    ]
  }
]

// 查看分镜头通道
const channels = __debugTreeData
  .flatMap(d => d.channels || [])
  .filter(c => c.type === 'channel');
  
console.log('分镜头数量:', channels.length);  // 应该是 48
console.table(channels);
```

---

## ⚙️ 配置总结

### 已更新的配置

✅ **登录账号**：`aqcenter55`（中心服务）  
✅ **登录密码**：`123`  
✅ **WebSocket 端口**：`7777`（中心服务）  
✅ **服务器地址**：`10.10.18.242`  
✅ **HTTP API 代理**：→ `10.10.18.242:8081`  

### 关键端口

- **7777**：中心服务 WebSocket（消息控制）
- **7788**：流媒体服务 WebSocket（视频流）✅ 由 SDK 自动使用
- **8081**：HTTP API（认证接口）
- **8899**：中心服务 HTTP
- **8866**：流媒体服务 HTTP

---

## 🎯 预期结果

页面打开后：

1. ✅ **自动登录**（使用 aqcenter55）
2. ✅ **WebSocket 连接**（ws://10.10.18.242:7777）
3. ✅ **获取设备数据**
   - 1 个拼接服务（4 主镜头）
   - 52 个摄像头
   - 48 个分镜头通道
4. ✅ **左侧显示设备列表**
5. ✅ **全景画面自动播放**（32:9）
6. ✅ **点击播放分镜头**

---

## 🚀 立即测试

### 1. 重启开发服务器
```bash
pnpm dev
```

### 2. 打开浏览器
```
http://localhost:3000
```

### 3. 查看控制台（F12）

应该看到登录成功和设备数据。

### 4. 如果有问题

在控制台执行：
```javascript
// 查看设备数据
__debugTreeData

// 手动刷新
__debugRefreshDevices()
```

---

## 📖 相关文档

我已创建的文档：
- ✅ `系统配置文档.md` - 完整的服务器配置说明
- ✅ `完整使用指南.md` - 详细的使用步骤和代码示例

现在配置已经正确，重启服务器后应该就能正常工作了！🎉

有任何问题随时告诉我！

