# 端口连接问题排查

## 测试结果

```powershell
ComputerName           : 10.10.18.242
RemotePort             : 7777
PingSucceeded          : True   ✅
TcpTestSucceeded       : False  ❌
```

## 问题确认

**7777 端口无法连接**

## 可能的原因

### 1. 防火墙阻止（最可能 90%）
- 服务器防火墙未开放 7777 端口
- 网络防火墙规则阻止

### 2. 服务未运行（可能 8%）
- WebSocket 服务没有启动
- 服务配置错误

### 3. 端口号错误（可能 2%）
- API 返回的端口号不对
- 实际运行在其他端口

## 需要服务器管理员协助

### 1. 检查服务状态

在服务器 10.10.18.242 上执行：

```bash
# 查看 7777 端口是否被监听
netstat -tulnp | grep 7777

# 或使用 ss 命令
ss -tulnp | grep 7777

# 或使用 lsof
lsof -i :7777
```

**预期输出**：
```
tcp        0      0 0.0.0.0:7777            0.0.0.0:*               LISTEN      12345/node
```

如果没有输出，说明服务未运行！

### 2. 检查防火墙规则

#### CentOS/RHEL/Fedora:
```bash
# 查看防火墙状态
firewall-cmd --state

# 查看已开放端口
firewall-cmd --list-ports

# 开放 7777 端口
firewall-cmd --zone=public --add-port=7777/tcp --permanent
firewall-cmd --reload
```

#### Ubuntu/Debian:
```bash
# 查看防火墙状态
ufw status

# 开放 7777 端口
ufw allow 7777/tcp
```

#### iptables:
```bash
# 查看规则
iptables -L -n

# 允许 7777 端口
iptables -A INPUT -p tcp --dport 7777 -j ACCEPT
```

### 3. 检查服务绑定地址

查看服务配置，确保绑定到 `0.0.0.0` 而不是 `127.0.0.1`：

```javascript
// ❌ 错误 - 只能本地访问
server.listen(7777, '127.0.0.1');

// ✅ 正确 - 可以远程访问
server.listen(7777, '0.0.0.0');
```

### 4. 启动 WebSocket 服务

如果服务未运行，需要启动：

```bash
# 假设使用 Node.js
cd /path/to/anktech-server
npm start

# 或使用 PM2
pm2 start websocket-server.js

# 或使用 systemd
systemctl start anktech-websocket
```

## 临时解决方案

### 方案 A: SSH 隧道（推荐用于测试）

如果您有服务器 SSH 访问权限：

```bash
# 在您的电脑上执行
ssh -L 7777:localhost:7777 user@10.10.18.242
```

然后修改配置：
```typescript
const LOGIN_CONFIG = {
  server: 'localhost',  // 通过隧道访问
  wsPort: 7777,
  userId: 'admin',
  password: '123456',
  debug: true,
};
```

### 方案 B: 使用不同的端口

如果 API 返回中还有其他端口信息，可以尝试：

```json
{
  "address": "10.10.18.242:8899",  // 这个端口可能也有 WebSocket？
  "wsPort": 7777
}
```

测试 8899 端口：
```powershell
Test-NetConnection -ComputerName 10.10.18.242 -Port 8899
```

## 检查清单

发送给服务器管理员：

- [ ] 确认 AnkTech WebSocket 服务是否正在运行
- [ ] 确认服务监听在 7777 端口
- [ ] 确认服务绑定到 `0.0.0.0`（而不是 `127.0.0.1`）
- [ ] 确认服务器防火墙已开放 7777 端口
- [ ] 确认网络防火墙允许 7777 端口
- [ ] 提供正确的 WebSocket 连接信息

## 验证步骤

管理员完成配置后，您可以验证：

```powershell
# 1. 测试端口
Test-NetConnection -ComputerName 10.10.18.242 -Port 7777

# 预期结果
TcpTestSucceeded : True  ✅
```

```bash
# 2. 使用 telnet 测试
telnet 10.10.18.242 7777

# 如果连接成功，会看到空白屏幕（表示已连接）
```

## 常见错误配置示例

### 错误 1: Nginx 反向代理配置不当
```nginx
# ❌ 缺少 WebSocket 升级配置
location /ws/ {
    proxy_pass http://localhost:7777;
}

# ✅ 正确配置
location /ws/ {
    proxy_pass http://localhost:7777;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### 错误 2: 服务只监听 IPv6
```bash
# 服务可能只监听 IPv6
tcp6       0      0 :::7777                 :::*                    LISTEN

# 需要同时监听 IPv4
tcp        0      0 0.0.0.0:7777            0.0.0.0:*               LISTEN
```

### 错误 3: SELinux 阻止
```bash
# CentOS/RHEL 上检查 SELinux
getenforce

# 临时禁用测试
setenforce 0

# 永久配置
semanage port -a -t http_port_t -p tcp 7777
```

## 总结

当前问题：**服务器 7777 端口无法访问**

最可能原因：**防火墙未开放 7777 端口**

立即行动：联系服务器管理员，提供此文档，请求开放 7777 端口。

