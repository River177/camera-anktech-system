# WebSocket 连接问题故障排查

## ❌ 错误信息
```
WebSocket connection to 'ws://10.10.18.242:7777/' failed: 
Error in connection establishment: net::ERR_CONNECTION_REFUSED
```

## 🔍 问题原因

### 1. 跨域安全策略
- 浏览器从 `localhost:3000` 访问页面
- 尝试直接连接 `ws://10.10.18.242:7777`
- 浏览器 CORS 策略阻止跨域 WebSocket 连接

### 2. 网络配置
- 防火墙可能阻止 7777 端口
- 服务器可能只监听特定 IP
- WebSocket 端点可能未正确配置

## ✅ 解决方案

### 方案 1: 使用 Vite 代理（推荐）

#### 步骤 1: 配置 Vite 代理
在 `vite.config.ts` 中：
```typescript
server: {
  proxy: {
    // HTTP API 代理
    '/aqueti-api': {
      target: 'http://10.10.18.242:8081',
      ws: false,
      changeOrigin: true,
      secure: false,
    },
    // WebSocket 代理
    '/ws': {
      target: 'ws://10.10.18.242:7777',
      ws: true,
      changeOrigin: true,
      secure: false,
    },
  },
}
```

#### 步骤 2: 修改登录配置
在 `src/pages/MonitoringPage.tsx` 中：
```typescript
const LOGIN_CONFIG = {
  server: window.location.hostname || 'localhost',
  wsPort: Number(window.location.port) || 3000,
  userId: 'admin',
  password: '123456',
  debug: true,
};
```

#### 步骤 3: 重启开发服务器
```bash
# Ctrl+C 停止
pnpm dev
```

### 方案 2: 直接连接（需要服务器支持）

如果服务器支持跨域：

```typescript
const LOGIN_CONFIG = {
  server: '10.10.18.242',
  wsPort: 7777,
  userId: 'admin',
  password: '123456',
  debug: true,
};
```

**服务器需要配置**:
- 允许 CORS
- WebSocket 端口对外开放
- 防火墙放行 7777 端口

## 🔍 调试方法

### 1. 检查网络连接
```bash
# 测试端口连通性
telnet 10.10.18.242 7777

# 或使用 PowerShell
Test-NetConnection -ComputerName 10.10.18.242 -Port 7777
```

### 2. 查看浏览器控制台
打开开发者工具 → Network → WS（WebSocket）标签：
- 查看连接状态（Pending/Failed/Established）
- 检查请求 URL
- 查看错误详情

### 3. 检查代理是否生效
在浏览器中访问：
```
http://localhost:3000/aqueti-api/your-endpoint
```
应该能成功代理到后端。

### 4. AnkTech SDK 日志
查看控制台中的 `[AnkTech]` 日志：
```javascript
[AnkTech] SDK版本: xxx
[AnkTech] 正在连接 WebSocket: ws://...
[AnkTech] WebSocket 连接成功
[AnkTech] 登录成功
```

## 📊 API 返回数据分析

您的 findList 返回：
```json
{
  "serverId": "aqcenter55",
  "address": "10.10.18.242:8899",
  "wsPort": 7777,
  "isOnline": 1
}
```

说明：
- ✅ 服务器在线 (`isOnline: 1`)
- ✅ WebSocket 端口是 7777
- ❌ 但浏览器无法直接连接（需要代理）

## 🛠️ 常见问题

### Q1: 代理配置后还是连接失败？
**检查**:
1. 是否重启了开发服务器
2. 清除浏览器缓存
3. 检查 `vite.config.ts` 语法是否正确

### Q2: 如何验证代理是否工作？
在浏览器控制台执行：
```javascript
const ws = new WebSocket('ws://localhost:3000/ws');
ws.onopen = () => console.log('代理连接成功！');
ws.onerror = (e) => console.error('代理连接失败', e);
```

### Q3: 生产环境怎么办？
生产环境需要：
1. 使用 Nginx 反向代理
2. 配置正确的 WebSocket 升级
3. 或者确保服务器支持 CORS

**Nginx 配置示例**:
```nginx
location /ws/ {
    proxy_pass http://10.10.18.242:7777/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}
```

## 📝 检查清单

- [ ] Vite 配置中添加 WebSocket 代理
- [ ] 修改 LOGIN_CONFIG 使用相对路径
- [ ] 重启开发服务器
- [ ] 清除浏览器缓存
- [ ] 检查控制台 WebSocket 连接状态
- [ ] 确认服务器 7777 端口开放
- [ ] 测试网络连通性

## 🎯 预期结果

配置正确后，控制台应该看到：
```
[AnkTech] SDK版本: xxx
[AnkTech] 登录成功
[AnkTech] WebSocket 已连接
[AnkTech] 收到消息: 900001
[AnkTech] 收到消息: 30006
```

Network 标签 WS 部分显示：
- Status: 101 Switching Protocols
- Type: websocket
- 可以看到消息帧（Frames）

## 💡 提示

如果仍然无法连接：
1. 联系服务器管理员检查防火墙配置
2. 确认服务器 WebSocket 服务正常运行
3. 尝试使用其他 WebSocket 测试工具（如 wscat）验证服务器

